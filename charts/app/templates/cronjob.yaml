{{- range $workload := .Values.spec.workloads }}
{{- if eq $workload.type "CronJob" }}
{{- $tlsEnabled := $.Values.spec.global.tls.enabled -}}
{{- if $workload.ingress }}
  {{- if and $workload.ingress.tls (hasKey $workload.ingress.tls "enabled") }}
    {{- $tlsEnabled = $workload.ingress.tls.enabled -}}
  {{- end }}
{{- end }}
{{- $tlsMount := false -}}
{{- if $workload.ingress }}
  {{- if and $workload.ingress.enabled $tlsEnabled }}
    {{- $tlsMount = true -}}
  {{- end }}
{{- end }}
{{- $csiMountPath := default "/mnt/secrets" $workload.csi.mountPath -}}
{{- $dotenvEnabled := $workload.csi.enabled -}}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "app.workloadName" (list $ $workload) }}
  namespace: {{ $.Values.spec.global.namespace }}
  labels:
    {{- include "app.commonLabels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $workload.name }}
    {{- with $.Values.spec.global.labels }}
{{ toYaml . | nindent 4 }}
    {{- end }}
spec:
  schedule: {{ $workload.schedule | quote }}
  {{- if $workload.concurrencyPolicy }}
  concurrencyPolicy: {{ $workload.concurrencyPolicy }}
  {{- end }}
  {{- if hasKey $workload "successfulJobsHistoryLimit" }}
  successfulJobsHistoryLimit: {{ $workload.successfulJobsHistoryLimit }}
  {{- end }}
  {{- if hasKey $workload "failedJobsHistoryLimit" }}
  failedJobsHistoryLimit: {{ $workload.failedJobsHistoryLimit }}
  {{- end }}
  {{- if hasKey $workload "startingDeadlineSeconds" }}
  startingDeadlineSeconds: {{ $workload.startingDeadlineSeconds }}
  {{- end }}
  {{- if hasKey $workload "suspend" }}
  suspend: {{ $workload.suspend }}
  {{- end }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "app.selectorLabels" (list $ $workload) | nindent 12 }}
            {{- with $.Values.spec.global.labels }}
{{ toYaml . | nindent 12 }}
            {{- end }}
            {{- with $workload.podLabels }}
{{ toYaml . | nindent 12 }}
            {{- end }}
          {{- with $workload.podAnnotations }}
          annotations:
{{ toYaml . | nindent 12 }}
          {{- end }}
        spec:
          restartPolicy: {{ default "OnFailure" $workload.restartPolicy }}
          {{- if $.Values.spec.global.imagePullSecrets }}
          imagePullSecrets:
          {{- range $secret := $.Values.spec.global.imagePullSecrets }}
          - name: {{ $secret }}
          {{- end }}
          {{- end }}
          {{- $saName := include "app.serviceAccountName" (list $ $workload) }}
          {{- if $saName }}
          serviceAccountName: {{ $saName }}
          {{- end }}
          {{- if $workload.nodeSelector }}
          nodeSelector:
{{ toYaml $workload.nodeSelector | nindent 12 }}
          {{- end }}
          {{- if $workload.tolerations }}
          tolerations:
{{ toYaml $workload.tolerations | nindent 12 }}
          {{- end }}
          {{- if $workload.affinity }}
          affinity:
{{ toYaml $workload.affinity | nindent 12 }}
          {{- end }}
          {{- if $dotenvEnabled }}
          initContainers:
          - name: dotenv-writer
            image: alpine:3.20
            imagePullPolicy: IfNotPresent
            command:
            - sh
            - -ec
            - |
              set -eu
              umask 077
              SECRETS_DIR={{ $csiMountPath | quote }}
              OUT_FILE="/work/.env"
              : > "$OUT_FILE"
              if [ ! -d "$SECRETS_DIR" ]; then
                echo "Secrets directory not found: $SECRETS_DIR" >&2
                exit 1
              fi
              # Emit KEY="value" lines; multiline values are escaped as \n.
              find "$SECRETS_DIR" -maxdepth 1 -type f | LC_ALL=C sort | while IFS= read -r file; do
                key="$(basename "$file")"
                escaped="$(sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e ':a;N;$!ba;s/\n/\\n/g' "$file")"
                printf '%s="%s"\n' "$key" "$escaped" >> "$OUT_FILE"
              done
            volumeMounts:
            - name: {{ include "app.csiVolumeName" (list $ $workload) }}
              mountPath: {{ $csiMountPath }}
              readOnly: true
            - name: {{ include "app.dotenvVolumeName" (list $ $workload) }}
              mountPath: /work
          {{- end }}
          containers:
          - name: {{ $workload.name }}
            image: "{{ $workload.image.repository }}:{{ $workload.image.tag }}"
            imagePullPolicy: {{ default "IfNotPresent" $workload.image.pullPolicy }}
            {{- $command := include "app.renderCommand" (list $workload) }}
            {{- if $command }}
{{ $command | nindent 12 }}
            {{- end }}
            {{- if $workload.args }}
            args:
{{ toYaml $workload.args | nindent 14 }}
            {{- end }}
            {{- if $workload.env }}
            env:
            {{- range $env := $workload.env }}
            - name: {{ $env.name }}
              {{- if hasKey $env "value" }}
              value: {{ $env.value | quote }}
              {{- else if $env.valueFromSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $env.valueFromSecret.name }}
                  key: {{ $env.valueFromSecret.key }}
              {{- else if $env.valueFromConfigMap }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $env.valueFromConfigMap.name }}
                  key: {{ $env.valueFromConfigMap.key }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if $workload.envFrom }}
            envFrom:
{{ toYaml $workload.envFrom | nindent 14 }}
            {{- end }}
            {{- $resources := include "app.resolveResources" (list $ $workload) }}
            {{- if $resources }}
            resources:
{{ $resources | nindent 14 }}
            {{- end }}
            {{- $hasMounts := or $workload.volumeMounts $workload.csi.enabled $tlsMount $dotenvEnabled }}
            {{- if $hasMounts }}
            volumeMounts:
            {{- range $mount := $workload.volumeMounts }}
            - name: {{ $mount.name }}
              mountPath: {{ $mount.mountPath }}
              {{- if hasKey $mount "subPath" }}
              subPath: {{ $mount.subPath }}
              {{- end }}
              {{- if hasKey $mount "readOnly" }}
              readOnly: {{ $mount.readOnly }}
              {{- end }}
            {{- end }}
            {{- if $workload.csi.enabled }}
            - name: {{ include "app.csiVolumeName" (list $ $workload) }}
              mountPath: {{ $csiMountPath }}
              readOnly: {{ default true $workload.csi.readOnly }}
            {{- end }}
            {{- if $dotenvEnabled }}
            - name: {{ include "app.dotenvVolumeName" (list $ $workload) }}
              mountPath: /app/.env
              subPath: .env
              readOnly: true
            {{- end }}
            {{- if $tlsMount }}
            - name: tls-certs
              mountPath: /mnt/tls
              readOnly: true
            {{- end }}
            {{- end }}
          {{- $hasVolumes := or $workload.volumes $workload.csi.enabled $tlsMount $dotenvEnabled }}
          {{- if $hasVolumes }}
          volumes:
          {{- range $volume := $workload.volumes }}
          - name: {{ $volume.name }}
            {{- if $volume.configMap }}
            configMap:
{{ toYaml $volume.configMap | nindent 14 }}
            {{- end }}
            {{- if $volume.secret }}
            secret:
{{ toYaml $volume.secret | nindent 14 }}
            {{- end }}
            {{- if $volume.emptyDir }}
            emptyDir:
{{ toYaml $volume.emptyDir | nindent 14 }}
            {{- end }}
            {{- if $volume.persistentVolumeClaim }}
            persistentVolumeClaim:
{{ toYaml $volume.persistentVolumeClaim | nindent 14 }}
            {{- end }}
            {{- if $volume.hostPath }}
            hostPath:
{{ toYaml $volume.hostPath | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if $workload.csi.enabled }}
          - name: {{ include "app.csiVolumeName" (list $ $workload) }}
            csi:
              driver: {{ default "secrets-store.csi.k8s.io" $workload.csi.driver }}
              readOnly: {{ default true $workload.csi.readOnly }}
              volumeAttributes:
                {{- if $workload.csi.secretProviderClass }}
                secretProviderClass: {{ $workload.csi.secretProviderClass }}
                {{- end }}
                {{- range $k, $v := $workload.csi.volumeAttributes }}
                {{- if ne $k "secretProviderClass" }}
                {{ $k }}: {{ $v | quote }}
                {{- end }}
                {{- end }}
          {{- end }}
          {{- if $dotenvEnabled }}
          - name: {{ include "app.dotenvVolumeName" (list $ $workload) }}
            emptyDir: {}
          {{- end }}
          {{- if $tlsMount }}
          - name: tls-certs
            secret:
              secretName: {{ include "app.tlsSecretName" (list $ $workload) }}
          {{- end }}
          {{- end }}
{{- end }}
{{- end }}

