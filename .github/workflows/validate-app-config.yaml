name: Validate App Config

on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:
    inputs:
      deployed_apps_json:
        description: "Optional deployed_apps_json payload (new app/workload shape)"
        required: false
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install jsonschema PyYAML

    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.14.4

    - name: Validate checked-in AppConfig schema
      run: |
        python scripts/validate_app_config.py \
          --config config/app-config.yaml \
          --schema schemas/app-config.schema.json

    - name: Run multi-workload rendering tests
      run: python -m unittest discover -s tests -p "test_*.py"

    - name: Validate workflow payload if provided
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.deployed_apps_json != '' }}
      env:
        DEPLOYED_APPS_JSON: ${{ inputs.deployed_apps_json }}
      run: |
        python scripts/generate_app_config.py \
          --output .tmp/workflow.app-config.yaml \
          --schema schemas/app-config.schema.json \
          --bootstrap-repo-url https://github.com/your-org/your-repo \
          --bootstrap-env dev \
          --bootstrap-target-revision main \
          --bootstrap-argo-namespace argocd \
          --base-domain example.com
        helm template workflow charts/app -f .tmp/workflow.app-config.yaml > .tmp/workflow.rendered.yaml
